generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  password        String
  role            String
  isFirstLogin    Boolean           @default(true)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       AuditLog[]
  passwordHistory PasswordHistory[]
  approvedRfqs    RFQ[]             @relation("RFQApprovals")
  createdRfqs     RFQ[]
  rfqApprovals    RFQApproval[]
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  phone          String?
  address        String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqs           RFQ[]
  vendorProducts VendorProduct[]
}

model Product {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  category              String?
  unit                  String
  attributes            Json            @default("{}")
  traceabilityQuestions Json            @default("[]")
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  rfqItems              RFQItem[]
  POLine                POLine[]
  vendorProducts        VendorProduct[]
}

model RFQ {
  id               String        @id @default(cuid())
  orderDeadline    DateTime
  sentDate         DateTime?
  status           String        @default("draft")
  createdById      String
  approvedById     String?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  approvedAt       DateTime?
  expectedDelivery DateTime?
  rfqNumber        String        @unique
  vendorId         String
  vendorNotes      String?
  vendorPrice      Decimal?
  approvedBy       User?         @relation("RFQApprovals", fields: [approvedById], references: [id])
  createdBy        User          @relation(fields: [createdById], references: [id])
  vendor           Vendor        @relation(fields: [vendorId], references: [id])
  approvals        RFQApproval[]
  items            RFQItem[]
}

model RFQItem {
  id        String @id @default(cuid())
  rfqId     String
  productId String
  quantity  Int
  unit      String

  // Vendor Quote Details (per item)
  unitPrice            Decimal?
  expectedDeliveryDate DateTime?
  traceabilityAnswers  Json      @default("[]")
  customFieldAnswers   Json      @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model RFQApproval {
  id         String   @id @default(cuid())
  rfqId      String
  approvedBy String
  status     String
  comments   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation(fields: [approvedBy], references: [id])
  rfq        RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

// Supplier model (legacy external supplier directory)
model Supplier {
  supplierId  String  @id @map("supplier_id")
  name        String
  contactInfo String? @map("contact_info")
  email       String
  phone       String?

  // Relations
  purchaseOrders PurchaseOrder[]

  @@map("Supplier")
}

// Purchase Order model
model PurchaseOrder {
  poId        String   @id @map("po_id")
  rfqId       String?  @map("rfq_id")
  supplierId  String   @map("supplier_id")
  dateCreated DateTime @default(now()) @map("date_created")
  status      String   @default("draft")

  // Relations
  supplier Supplier @relation(fields: [supplierId], references: [supplierId])
  lines    POLine[]

  @@map("PurchaseOrder")
}

// Purchase Order Line model
model POLine {
  poLineId         String  @id @map("po_line_id")
  poId             String  @map("po_id")
  productId        String  @map("product_id")
  quantityOrdered  Int     @map("quantity_ordered")
  quantityReceived Int     @default(0) @map("quantity_received")
  price            Decimal

  // Relations
  purchaseOrder PurchaseOrder        @relation(fields: [poId], references: [poId])
  product       Product              @relation(fields: [productId], references: [id])
  traceability  ProductTraceability?

  @@map("POLine")
}

// Product Traceability model - tracks the supply chain for each product in a purchase
model ProductTraceability {
  id       String @id @default(cuid())
  poLineId String @unique @map("po_line_id")

  // Farm Section
  farmId             String?
  animalType         String?
  farmLocation       String?
  farmCertifications Json?   @default("[]")

  // Slaughter House Section
  supplier                String?
  slaughterAnimalType     String?
  origin                  String?
  hideSkinType            String?
  hideSkinId              String?
  slaughterDate           DateTime?
  slaughterLocation       String?
  slaughterCertifications Json?     @default("[]")

  // Tannery Section
  tanneryName           String?
  tanneryLocation       String?
  tanningType           String?
  article               String?
  vehicleNumber         String?
  processedLotNumber    String?
  envParameters         Json?   @default("{}")
  tanneryCertifications Json?   @default("[]")

  // Factory Section
  factoryName          String?
  factoryLocation      String?
  materialType         String?
  product              String?
  finishDate           DateTime?
  hardLabourUsed       String?
  care                 String?
  brand                String?
  factoryCertification String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  poLine POLine @relation(fields: [poLineId], references: [poLineId], onDelete: Cascade)

  @@map("ProductTraceability")
}

// Vendor-Product relationship (many-to-many with additional fields)
model VendorProduct {
  id        String   @id @default(cuid())
  vendorId  String
  productId String
  price     Decimal? // Optional price for this vendor-product combination
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId])
  @@index([productId])
}

model Organization {
  id                   String    @id @default(cuid())
  companyName          String
  companyLogo          String? // Path to the logo file or Base64
  shortName            String?
  address              String?
  factoryContactNo     String?
  email                String?
  fullAddress          String?
  auditDate            DateTime?
  internalAuditorNames Json?     @default("[]") // Array of auditor names
  dataFrom             DateTime?

  // Section 1: General Facility Details
  siteNameLocalLanguage    String?
  siteURN                  String?
  fullestScopeOfOperations String? // Category A-G
  abbreviations            Json?   @default("[]") // Array of {abbreviation, fullTitle}

  // Section 2: Company Registration
  companyRegistrationNumber String?

  // Section 3: Geographical Coordinates
  latitude  String?
  longitude String?

  // Section 4: Location
  country String?

  // Section 5: Contact
  telephoneNumber String?

  // Section 6a: Principal Contact
  principalContactName     String?
  principalContactPosition String?
  principalContactEmail    String?

  // Section 6b: Environmental Responsible
  environmentalResponsibleName     String?
  environmentalResponsiblePosition String?
  environmentalResponsibleEmail    String?

  // Additional Information
  lwgCommunicationsMembers Json?   @default("[]") // Array of {email, communicationRequired}
  website                  String?
  facilityDescription      String? // Description of facility, site setting, environmental receptors
  totalSiteArea            String? // Total site area in m²
  siteAreaBoundaries       String? // Single or multiple boundaries

  // Workforce Information - Direct Labour
  directLabourShiftAM    Int?
  directLabourShiftPM    Int?
  directLabourShiftNight Int?
  directLabourCount      Int?

  // Workforce Information - Indirect Labour
  indirectLabourShiftAM    Int?
  indirectLabourShiftPM    Int?
  indirectLabourShiftNight Int?
  indirectLabourCount      Int?

  // Workforce Information - Shift Total
  shiftTotalAM    Int?
  shiftTotalPM    Int?
  shiftTotalNight Int?
  shiftTotal      Int?

  // Operating Schedule - Worker
  workerDaysPerWeek  Int?
  workerWeeksPerYear Int?
  workerDaysPerYear  Int?

  // Operating Schedule - Manufacturing operations
  manufacturingDaysPerWeek  Int?
  manufacturingWeeksPerYear Int?
  manufacturingDaysPerYear  Int?

  // Environmental and Operations
  environmentalImpacts            String? // Environmental impacts description
  operationsForOtherOrganisations String? // Operations for other organisations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String   @unique
  docNo       String?
  revDate     String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Employee {
  id               String    @id @default(cuid())
  employeeId       String    @unique
  idCardNumber     String?
  name             String
  photo            String?
  parentName       String? // Father/Mother
  dob              DateTime?
  address          String?
  gender           String?
  contactNumber    String?
  emergencyContact String?
  dateOfJoining    DateTime?
  department       String?
  lastEmployment   String?
  process          String?
  designation      String?
  salary           Decimal?
  dateOfLeaving    DateTime?
  shift            String?
  secondaryJob     String?

  // Certifications/Roles
  isFirstAider         Boolean @default(false)
  isEmergencyResponder Boolean @default(false)
  isFirefighter        Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Machine {
  id                String  @id @default(cuid())
  serialNumber      String?
  machineId         String  @unique
  name              String
  quantity          Int     @default(1)
  motorDetails      String?
  powerRating       String?
  airPressure       String?
  modelNumber       String?
  manufacturingYear String?
  length            String?
  width             String?
  height            String?
  steamTemp         String?
  steamConsumption  String?
  electricityRating String?
  operationType     String?
  department        String?
  status            String? // "in_use", "under_maintenance", "out_of_order"
  remarks           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permit {
  id                    String    @id @default(cuid())
  title                 String    @unique
  authorizedNumber      String?
  issuingAuthority      String?
  dateOfIssue           DateTime?
  dateOfExpiry          DateTime?
  renewalSubmissionDate DateTime?
  reportingFrequency    String?
  lastReportDate        DateTime?
  responsiblePerson     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Incoming Traceability Models

// Supplier Leather Warehouse - tracks warehouses where suppliers store leather
model SupplierLeatherWarehouse {
  id              String   @id @default(cuid())
  warehouseName   String   @unique // Warehouse name/identifier
  supplierId      String?  // Reference to Supplier (optional)
  supplierName    String?  // Supplier name (denormalized, optional)
  location        String?  // Warehouse location/address
  region          String?  // Region
  lwgCertified    Boolean  @default(false) // Whether warehouse is LWG certified
  capacity        Decimal? // Storage capacity
  capacityUnit    String?  // Unit for capacity (e.g., kg, m²)
  contactPerson   String?  // Contact person at warehouse
  contactPhone    String?  // Contact phone
  contactEmail    String?  // Contact email
  notes           String?
  status          String   @default("active") // active, inactive
  
  // Relations
  igps            InwardGatePass[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([supplierId])
  @@index([warehouseName])
  @@index([status])
}

// Inward Gate Pass (IGP) - tracks incoming material from suppliers
model InwardGatePass {
  id              String   @id @default(cuid())
  igpNumber       String   @unique // IGP number
  supplierId      String   // Reference to Supplier
  supplierName    String   // Supplier name (denormalized for quick access)
  warehouseId     String?  // Reference to Supplier Leather Warehouse
  warehouseName   String?  // Warehouse name (denormalized)
  region          String?  // Region of origin
  deliveryDate    DateTime // Date when material arrived at tannery
  truckLoadNumber String?  // Truck load identifier
  batchNumber     String?  // Batch number from supplier
  lwgCertified    Boolean  @default(false) // Whether supplier is LWG certified
  notes           String?
  status          String   @default("pending") // pending, received, processed
  
  // Relations
  warehouse       SupplierLeatherWarehouse? @relation(fields: [warehouseId], references: [id])
  rawBatches      RawBatch[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([supplierId])
  @@index([warehouseId])
  @@index([igpNumber])
}

// Raw Batch - tracks raw leather batches
model RawBatch {
  id              String   @id @default(cuid())
  batchCode       String   @unique // Format: 0001, 0002, etc.
  igpId           String   // Reference to IGP
  supplierId      String   // Supplier reference
  supplierName    String   // Supplier name
  region          String?  // Region
  receivedDate    DateTime // Date received at tannery
  quantity        Decimal? // Quantity (weight or pieces)
  unit            String?  // Unit of measurement
  status          String   @default("pending") // pending, tanned, in_process
  
  // Relations
  igp             InwardGatePass      @relation(fields: [igpId], references: [id])
  wetBlueBatches  WetBlueBatch[]
  jobCards        JobCard[]
  batchCards      BatchCard[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([batchCode])
  @@index([igpId])
}

// Wet Blue Batch - tracks wet blue batches
model WetBlueBatch {
  id              String   @id @default(cuid())
  wbCode          String   @unique // Format: 10000, 10001, etc. (W/B Code)
  rawBatchId      String   // Reference to raw batch
  rawBatchCode    String   // Raw batch code (denormalized)
  receivedDate    DateTime // Date when wet blue was created
  quantity        Decimal? // Quantity
  unit            String?  // Unit of measurement
  status          String   @default("pending") // pending, sorted, measured, graded
  
  // Relations
  rawBatch        RawBatch           @relation(fields: [rawBatchId], references: [id])
  reTanningBatches ReTanningBatch[]
  gradeAssortments GradeAssortment[]
  jobCards        JobCard[]
  batchCards      BatchCard[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([wbCode])
  @@index([rawBatchId])
}

// Grade Assortment - tracks grading of wet blue
model GradeAssortment {
  id            String   @id @default(cuid())
  wbBatchId     String   // Reference to wet blue batch
  wbCode        String   // W/B Code (denormalized)
  grade         String   // Grade: 1,2,3,4,5 (A Grade), 6,7 (B Grade), 8,9 (C Grade)
  gradeCategory String?  // A, B, or C Grade
  quantity      Decimal? // Quantity for this grade
  unit          String?  // Unit of measurement
  notes         String?
  
  // Relations
  wbBatch       WetBlueBatch @relation(fields: [wbBatchId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([wbBatchId])
  @@index([grade])
}

// Re-tanning Batch - tracks re-tanning process
model ReTanningBatch {
  id              String   @id @default(cuid())
  rtCode          String   @unique // Format: RKRCRT00102 (Re-tannage - batch code - month)
  wbBatchId       String   // Reference to wet blue batch
  wbCode          String   // W/B Code (denormalized)
  rawBatchId      String?  // Reference to original raw batch (for traceability)
  rawBatchCode    String?  // Raw batch code (denormalized)
  receivedDate    DateTime // Date when re-tanning started
  quantity        Decimal? // Quantity
  unit            String?  // Unit of measurement
  recipe          String?  // Recipe used
  technicianId    String?  // Technician in charge
  technicianName  String?  // Technician name (denormalized)
  status          String   @default("pending") // pending, in_process, completed
  
  // Relations
  wbBatch         WetBlueBatch        @relation(fields: [wbBatchId], references: [id])
  finishedBatches FinishedLeatherBatch[]
  jobCards        JobCard[]
  batchCards      BatchCard[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([rtCode])
  @@index([wbBatchId])
}

// Finished Leather Batch - tracks finished leather
model FinishedLeatherBatch {
  id              String   @id @default(cuid())
  batchNumber      String   @unique // Batch number for finished leather
  rtBatchId        String   // Reference to re-tanning batch
  rtCode           String   // Re-tanning code (denormalized)
  wbBatchId        String?  // Reference to wet blue batch (for traceability)
  wbCode           String?  // W/B Code (denormalized)
  rawBatchId       String?  // Reference to original raw batch (for traceability)
  rawBatchCode     String?  // Raw batch code (denormalized)
  completionDate   DateTime // Date when finished
  quantity         Decimal? // Quantity
  unit             String?  // Unit of measurement
  thickness        Decimal? // Thickness
  color            String?  // Color
  weight           Decimal? // Weight
  pieces           Int?     // Number of pieces
  areaM2           Decimal? // Area in square meters
  customerOrderNumber String? // Customer order number
  vendorCode       String?   // Vendor code
  status           String   @default("pending") // pending, completed, dispatched
  
  // Relations
  rtBatch          ReTanningBatch @relation(fields: [rtBatchId], references: [id])
  jobCards         JobCard[]
  batchCards       BatchCard[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([batchNumber])
  @@index([rtBatchId])
}

// Job Card - tracks job cards linked to batches
model JobCard {
  id              String   @id @default(cuid())
  jobCardNumber   String   @unique // Job card number
  rawBatchId      String?  // Reference to raw batch
  wbBatchId       String?  // Reference to wet blue batch
  rtBatchId       String?  // Reference to re-tanning batch
  finishedBatchId String?  // Reference to finished leather batch
  
  // Job card details
  recipe          String?  // Recipe
  technicianId    String?  // Technician in charge
  technicianName  String?  // Technician name
  date            DateTime // Date
  month           Int?     // Month
  year            Int?     // Year
  notes           String?
  
  // Relations
  rawBatch        RawBatch?          @relation(fields: [rawBatchId], references: [id])
  wbBatch         WetBlueBatch?      @relation(fields: [wbBatchId], references: [id])
  rtBatch         ReTanningBatch?    @relation(fields: [rtBatchId], references: [id])
  finishedBatch   FinishedLeatherBatch? @relation(fields: [finishedBatchId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([jobCardNumber])
}

// Batch Card - tracks batch cards at different production stages
model BatchCard {
  id              String   @id @default(cuid())
  cardNumber      String   @unique // Batch card number
  stage           String   // Stage: raw, wet_blue, re_tanning, finished
  rawBatchId      String?  // Reference to raw batch
  wbBatchId       String?  // Reference to wet blue batch
  rtBatchId       String?  // Reference to re-tanning batch
  finishedBatchId String?  // Reference to finished leather batch
  
  // Batch card details
  location        String?  // Current location
  status          String   @default("active") // active, transferred, completed
  notes           String?
  
  // Relations
  rawBatch        RawBatch?          @relation(fields: [rawBatchId], references: [id])
  wbBatch         WetBlueBatch?      @relation(fields: [wbBatchId], references: [id])
  rtBatch         ReTanningBatch?    @relation(fields: [rtBatchId], references: [id])
  finishedBatch   FinishedLeatherBatch? @relation(fields: [finishedBatchId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([cardNumber])
  @@index([stage])
}

// Production Stage - tracks production stages and movements
model ProductionStage {
  id              String   @id @default(cuid())
  stageName       String   // Stage name: RAW, WB_MEASUREMENT, GRADE, RETANNING, CRUST, FINISHED, etc.
  stageType       String   // Type: input, process, output
  description     String?  // Description of the stage
  order           Int      // Order in the production flow
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([stageName])
  @@index([order])
}
