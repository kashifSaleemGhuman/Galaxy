generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  password        String
  role            String
  isFirstLogin    Boolean           @default(true)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       AuditLog[]
  passwordHistory PasswordHistory[]
  approvedRfqs    RFQ[]             @relation("RFQApprovals")
  createdRfqs     RFQ[]
  rfqApprovals    RFQApproval[]
}

// Role model for permission management
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json     // JSON object containing role permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  phone          String?
  address        String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqs           RFQ[]
  vendorProducts VendorProduct[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?
  unit        String   // pcs, kg, m, etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  rfqItems              RFQItem[]
  poLines               POLine[]
  incomingShipmentLines IncomingShipmentLine[]
  inventoryItems        InventoryItem[]
  stockMovements        StockMovement[]
  vendorProducts        VendorProduct[]
}

// RFQ (Request for Quotation) model
model RFQ {
  id               String        @id @default(cuid())
  orderDeadline    DateTime
  sentDate         DateTime?
  status           String        @default("draft")
  createdById      String
  approvedById     String?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  approvedAt       DateTime?
  expectedDelivery DateTime?
  rfqNumber        String        @unique
  vendorId         String
  vendorNotes      String?
  vendorPrice      Decimal?
  approvedBy       User?         @relation("RFQApprovals", fields: [approvedById], references: [id])
  createdBy        User          @relation(fields: [createdById], references: [id])
  vendor           Vendor        @relation(fields: [vendorId], references: [id])
  approvals        RFQApproval[]
  items            RFQItem[]
}

model RFQItem {
  id        String @id @default(cuid())
  rfqId     String
  productId String
  quantity  Int
  unit      String

  // Vendor Quote Details (per item)
  unitPrice            Decimal?
  expectedDeliveryDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model RFQApproval {
  id         String   @id @default(cuid())
  rfqId      String
  approvedBy String
  status     String
  comments   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation(fields: [approvedBy], references: [id])
  rfq        RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

// Supplier model (legacy external supplier directory)
model Supplier {
  supplierId  String  @id @map("supplier_id")
  name        String
  contactInfo String? @map("contact_info")
  email       String
  phone       String?

  // Relations
  purchaseOrders PurchaseOrder[]
  
  @@map("Supplier")
}

// Purchase Order model
model PurchaseOrder {
  poId        String   @id @map("po_id")
  rfqId       String?  @map("rfq_id")
  supplierId  String   @map("supplier_id")
  dateCreated DateTime @default(now()) @map("date_created")
  status      String   @default("draft") // draft, sent, confirmed, approved, received, cancelled
  approvedAt  DateTime?
  approvedBy  String?
  
  // Relations
  supplier    Supplier @relation(fields: [supplierId], references: [supplierId])
  lines       POLine[]
  goodsReceipts GoodsReceipt[]
  vendorBills VendorBill[]
  incomingShipments IncomingShipment[]
  
  @@map("PurchaseOrder")
}

// Purchase Order Line model
model POLine {
  poLineId         String  @id @map("po_line_id")
  poId             String  @map("po_id")
  productId        String  @map("product_id")
  quantityOrdered  Int     @map("quantity_ordered")
  quantityReceived Int     @default(0) @map("quantity_received")
  price            Decimal

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [poId])
  product       Product       @relation(fields: [productId], references: [id])

  @@map("POLine")
}

// Vendor Bill model
model VendorBill {
  billId     String   @id @map("bill_id")
  poId       String   @map("po_id")
  dateBilled DateTime @map("date_billed")
  amount     Decimal
  status     String   // pending, paid, overdue
  
  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [poId])
}

// Goods Receipt model
model GoodsReceipt {
  id          String   @id @default(cuid())
  poId        String   @map("po_id")
  receiptDate DateTime @default(now()) @map("receipt_date")
  status      String   @default("pending") // pending, completed, rejected
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [poId])
}

// Warehouse model
model Warehouse {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  incomingShipments IncomingShipment[]
  inventoryItems    InventoryItem[]
  stockMovements    StockMovement[]
}

// Incoming Shipment model
model IncomingShipment {
  id              String   @id @default(cuid())
  shipmentNumber  String   @unique
  poId            String   @map("po_id")
  warehouseId     String?  @map("warehouse_id")
  status          String   @default("pending") // pending, assigned, received, processed, rejected
  assignedAt      DateTime?
  assignedBy      String?
  receivedAt      DateTime?
  processedAt     DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [poId])
  warehouse       Warehouse?    @relation(fields: [warehouseId], references: [id])
  lines           IncomingShipmentLine[]
  stockMovements  StockMovement[]
}

// Incoming Shipment Line model
model IncomingShipmentLine {
  id                String   @id @default(cuid())
  shipmentId        String   @map("shipment_id")
  productId         String   @map("product_id")
  quantityExpected  Int      @map("quantity_expected")
  quantityReceived  Int      @default(0) @map("quantity_received")
  quantityAccepted  Int      @default(0) @map("quantity_accepted")
  quantityRejected  Int      @default(0) @map("quantity_rejected")
  unitPrice         Decimal  @map("unit_price")
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  shipment          IncomingShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  product           Product          @relation(fields: [productId], references: [id])
}

// Inventory Item model
model InventoryItem {
  id          String   @id @default(cuid())
  productId   String   @map("product_id")
  warehouseId String   @map("warehouse_id")
  quantity    Int      @default(0)
  reserved    Int      @default(0)
  available   Int      @default(0)
  minLevel    Int      @default(0)
  maxLevel    Int      @default(0)
  location    String?  // Warehouse location/bay
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  stockMovements StockMovement[]
  
  @@unique([productId, warehouseId])
}

// Stock Movement model
model StockMovement {
  id              String   @id @default(cuid())
  productId       String   @map("product_id")
  warehouseId     String   @map("warehouse_id")
  shipmentId      String?  @map("shipment_id")
  type            String   // in, out, transfer, adjustment
  quantity        Int
  reason          String?
  reference       String?  // PO, SO, etc.
  createdBy       String?
  createdAt       DateTime @default(now())
  
  // Relations
  product         Product          @relation(fields: [productId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  shipment        IncomingShipment? @relation(fields: [shipmentId], references: [id])
  inventoryItem   InventoryItem    @relation(fields: [productId, warehouseId], references: [productId, warehouseId])
}

// Vendor-Product relationship (many-to-many with additional fields)
model VendorProduct {
  id        String   @id @default(cuid())
  vendorId  String
  productId String
  price     Decimal? // Optional price for this vendor-product combination
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId])
  @@index([productId])
}