generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  password        String
  role            String
  isFirstLogin    Boolean           @default(true)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       AuditLog[]
  passwordHistory PasswordHistory[]
  approvedRfqs    RFQ[]             @relation("RFQApprovals")
  createdRfqs     RFQ[]
  rfqApprovals    RFQApproval[]
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  phone          String?
  address        String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqs           RFQ[]
  vendorProducts VendorProduct[]
}

model Product {
  id             String          @id @default(cuid())
  name           String
  description    String?
  category       String?
  unit           String
  attributes     Json            @default("{}")
  traceabilityQuestions Json     @default("[]")
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqItems       RFQItem[]
  POLine         POLine[]
  vendorProducts VendorProduct[]
}

model RFQ {
  id               String        @id @default(cuid())
  orderDeadline    DateTime
  sentDate         DateTime?
  status           String        @default("draft")
  createdById      String
  approvedById     String?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  approvedAt       DateTime?
  expectedDelivery DateTime?
  rfqNumber        String        @unique
  vendorId         String
  vendorNotes      String?
  vendorPrice      Decimal?
  approvedBy       User?         @relation("RFQApprovals", fields: [approvedById], references: [id])
  createdBy        User          @relation(fields: [createdById], references: [id])
  vendor           Vendor        @relation(fields: [vendorId], references: [id])
  approvals        RFQApproval[]
  items            RFQItem[]
}

model RFQItem {
  id        String @id @default(cuid())
  rfqId     String
  productId String
  quantity  Int
  unit      String

  // Vendor Quote Details (per item)
  unitPrice            Decimal?
  expectedDeliveryDate DateTime?
  traceabilityAnswers  Json        @default("[]")
  customFieldAnswers   Json        @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model RFQApproval {
  id         String   @id @default(cuid())
  rfqId      String
  approvedBy String
  status     String
  comments   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation(fields: [approvedBy], references: [id])
  rfq        RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

// Supplier model (legacy external supplier directory)
model Supplier {
  supplierId  String  @id @map("supplier_id")
  name        String
  contactInfo String? @map("contact_info")
  email       String
  phone       String?

  // Relations
  purchaseOrders PurchaseOrder[]
  
  @@map("Supplier")
}

// Purchase Order model
model PurchaseOrder {
  poId        String   @id @map("po_id")
  rfqId       String?  @map("rfq_id")
  supplierId  String   @map("supplier_id")
  dateCreated DateTime @default(now()) @map("date_created")
  status      String   @default("draft")

  // Relations
  supplier Supplier @relation(fields: [supplierId], references: [supplierId])
  lines    POLine[]
  
  @@map("PurchaseOrder")
}

// Purchase Order Line model
model POLine {
  poLineId         String  @id @map("po_line_id")
  poId             String  @map("po_id")
  productId        String  @map("product_id")
  quantityOrdered  Int     @map("quantity_ordered")
  quantityReceived Int     @default(0) @map("quantity_received")
  price            Decimal

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [poId])
  product       Product       @relation(fields: [productId], references: [id])

  @@map("POLine")
}

// Vendor-Product relationship (many-to-many with additional fields)
model VendorProduct {
  id        String   @id @default(cuid())
  vendorId  String
  productId String
  price     Decimal? // Optional price for this vendor-product combination
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId])
  @@index([productId])
}

model Organization {
  id                  String    @id @default(cuid())
  companyName         String
  companyLogo         String?   // Path to the logo file or Base64
  shortName           String?
  address             String?
  factoryContactNo    String?
  email               String?
  fullAddress         String?
  auditDate           DateTime?
  internalAuditorNames Json?       @default("[]") // Array of auditor names
  dataFrom            DateTime?
  
  // Section 1: General Facility Details
  siteNameLocalLanguage String?
  siteURN              String?
  fullestScopeOfOperations String? // Category A-G
  abbreviations        Json?       @default("[]") // Array of {abbreviation, fullTitle}
  
  // Section 2: Company Registration
  companyRegistrationNumber String?
  
  // Section 3: Geographical Coordinates
  latitude            String?
  longitude           String?
  
  // Section 4: Location
  country             String?
  
  // Section 5: Contact
  telephoneNumber     String?
  
  // Section 6a: Principal Contact
  principalContactName     String?
  principalContactPosition String?
  principalContactEmail    String?
  
  // Section 6b: Environmental Responsible
  environmentalResponsibleName     String?
  environmentalResponsiblePosition String?
  environmentalResponsibleEmail    String?
  
  // Additional Information
  lwgCommunicationsMembers Json?  @default("[]") // Array of {email, communicationRequired}
  website                  String?
  facilityDescription      String? // Description of facility, site setting, environmental receptors
  totalSiteArea            String? // Total site area in mÂ²
  siteAreaBoundaries       String? // Single or multiple boundaries
  
  // Workforce Information - Direct Labour
  directLabourShiftAM      Int?
  directLabourShiftPM      Int?
  directLabourShiftNight   Int?
  directLabourCount        Int?
  
  // Workforce Information - Indirect Labour
  indirectLabourShiftAM    Int?
  indirectLabourShiftPM    Int?
  indirectLabourShiftNight Int?
  indirectLabourCount      Int?
  
  // Workforce Information - Shift Total
  shiftTotalAM             Int?
  shiftTotalPM             Int?
  shiftTotalNight          Int?
  shiftTotal               Int?
  
  // Operating Schedule - Worker
  workerDaysPerWeek        Int?
  workerWeeksPerYear       Int?
  workerDaysPerYear        Int?
  
  // Operating Schedule - Manufacturing operations
  manufacturingDaysPerWeek Int?
  manufacturingWeeksPerYear Int?
  manufacturingDaysPerYear Int?
  
  // Environmental and Operations
  environmentalImpacts     String? // Environmental impacts description
  operationsForOtherOrganisations String? // Operations for other organisations
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model Document {
  id          String   @id @default(cuid())
  name        String   @unique
  docNo       String?
  revDate     String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Employee {
  id                   String    @id @default(cuid())
  employeeId           String    @unique
  idCardNumber         String?
  name                 String
  photo                String?
  parentName           String?   // Father/Mother
  dob                  DateTime?
  address              String?
  gender               String?
  contactNumber        String?
  emergencyContact     String?
  dateOfJoining        DateTime?
  department           String?
  lastEmployment       String?
  process              String?
  designation          String?
  salary               Decimal?
  dateOfLeaving        DateTime?
  shift                String?
  secondaryJob         String?
  
  // Certifications/Roles
  isFirstAider         Boolean   @default(false)
  isEmergencyResponder Boolean   @default(false)
  isFirefighter        Boolean   @default(false)

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model Machine {
  id                  String    @id @default(cuid())
  serialNumber        String?
  machineId           String    @unique
  name                String
  quantity            Int       @default(1)
  motorDetails        String?
  powerRating         String?
  airPressure         String?
  modelNumber         String?
  manufacturingYear   String?
  length              String?
  width               String?
  height              String?
  steamTemp           String?
  steamConsumption    String?
  electricityRating   String?
  operationType       String?
  department          String?
  status              String?   // "in_use", "under_maintenance", "out_of_order"
  remarks             String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model Permit {
  id                    String    @id @default(cuid())
  title                 String    @unique
  authorizedNumber      String?
  issuingAuthority      String?
  dateOfIssue           DateTime?
  dateOfExpiry          DateTime?
  renewalSubmissionDate DateTime?
  reportingFrequency    String?
  lastReportDate        DateTime?
  responsiblePerson     String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}
