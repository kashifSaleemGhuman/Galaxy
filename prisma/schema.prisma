generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  password        String
  role            String
  isFirstLogin    Boolean           @default(true)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       AuditLog[]
  passwordHistory PasswordHistory[]
  approvedRfqs    RFQ[]             @relation("RFQApprovals")
  createdRfqs     RFQ[]
  rfqApprovals    RFQApproval[]
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  phone          String?
  address        String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqs           RFQ[]
  vendorProducts VendorProduct[]
}

model Product {
  id             String          @id @default(cuid())
  name           String
  description    String?
  category       String?
  unit           String
  attributes     Json            @default("{}")
  traceabilityQuestions Json     @default("[]")
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  rfqItems       RFQItem[]
  POLine         POLine[]
  vendorProducts VendorProduct[]
}

model RFQ {
  id               String        @id @default(cuid())
  orderDeadline    DateTime
  sentDate         DateTime?
  status           String        @default("draft")
  createdById      String
  approvedById     String?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  approvedAt       DateTime?
  expectedDelivery DateTime?
  rfqNumber        String        @unique
  vendorId         String
  vendorNotes      String?
  vendorPrice      Decimal?
  approvedBy       User?         @relation("RFQApprovals", fields: [approvedById], references: [id])
  createdBy        User          @relation(fields: [createdById], references: [id])
  vendor           Vendor        @relation(fields: [vendorId], references: [id])
  approvals        RFQApproval[]
  items            RFQItem[]
}

model RFQItem {
  id        String @id @default(cuid())
  rfqId     String
  productId String
  quantity  Int
  unit      String

  // Vendor Quote Details (per item)
  unitPrice            Decimal?
  expectedDeliveryDate DateTime?
  traceabilityAnswers  Json        @default("[]")
  customFieldAnswers   Json        @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model RFQApproval {
  id         String   @id @default(cuid())
  rfqId      String
  approvedBy String
  status     String
  comments   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation(fields: [approvedBy], references: [id])
  rfq        RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

// Supplier model (legacy external supplier directory)
model Supplier {
  supplierId  String  @id @map("supplier_id")
  name        String
  contactInfo String? @map("contact_info")
  email       String
  phone       String?

  // Relations
  purchaseOrders PurchaseOrder[]
  
  @@map("Supplier")
}

// Purchase Order model
model PurchaseOrder {
  poId        String   @id @map("po_id")
  rfqId       String?  @map("rfq_id")
  supplierId  String   @map("supplier_id")
  dateCreated DateTime @default(now()) @map("date_created")
  status      String   @default("draft")

  // Relations
  supplier Supplier @relation(fields: [supplierId], references: [supplierId])
  lines    POLine[]
  
  @@map("PurchaseOrder")
}

// Purchase Order Line model
model POLine {
  poLineId         String  @id @map("po_line_id")
  poId             String  @map("po_id")
  productId        String  @map("product_id")
  quantityOrdered  Int     @map("quantity_ordered")
  quantityReceived Int     @default(0) @map("quantity_received")
  price            Decimal

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [poId])
  product       Product       @relation(fields: [productId], references: [id])

  @@map("POLine")
}

// Vendor-Product relationship (many-to-many with additional fields)
model VendorProduct {
  id        String   @id @default(cuid())
  vendorId  String
  productId String
  price     Decimal? // Optional price for this vendor-product combination
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId])
  @@index([productId])
}
